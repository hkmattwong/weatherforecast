<!DOCTYPE html>
<html>
   <head>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
   <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Weather Forecast</title>
      <link href='http://fonts.googleapis.com/css?family=Roboto:400,100,300' rel='stylesheet' type='text/css'>
      <link rel="stylesheet" href="styles.css">
      <link rel="stylesheet" href="normalize.css">
      <link rel="stylesheet" href="climacon-font/styles.css">
      <link rel="stylesheet" href="climacon.css">
	  <script>
	  var weekday=new Array(7);
         weekday[0]="Monday";
         weekday[1]="Tuesday";
         weekday[2]="Wednesday";
         weekday[3]="Thursday";
         weekday[4]="Friday";
         weekday[5]="Saturday";
         weekday[6]="Sunday";
      var currectloction="";
		function timeConverter(UNIX_timestamp){  // change the time
			var eleDate = new Date(parseInt(UNIX_timestamp)*1000);
		return eleDate.getFullYear()+"-"+("0" + (eleDate.getMonth() + 1)).slice(-2)+"-"+("0" + eleDate.getDate()).slice(-2)+" "
		+("0" + eleDate.getHours()).slice(-2)+":"+("0" + eleDate.getMinutes()).slice(-2)+":"+("0" + eleDate.getSeconds()).slice(-2);

		}
      function ajax_get(url, callback) {   // get the data
         xmlhttp = new XMLHttpRequest();
         xmlhttp.onreadystatechange = function() {
        if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
            console.log('responseText:' + xmlhttp.responseText);
            try {
                var data = JSON.parse(xmlhttp.responseText);
            } catch(err) {
                console.log(err.message + " in " + xmlhttp.responseText);
                return;
            }
            callback(data);
        }
    };
 
    xmlhttp.open("GET", url, true);
    xmlhttp.send();
}
function day(time){    // change the date
	var eleDate = new Date(parseInt(time)*1000);
		return ("0" + (eleDate.getMonth() + 1)).slice(-2)+"-"+("0" + eleDate.getDate()).slice(-2);
	//var d = new Date(parseInt(time)*1000);
	//return weekday[d.getDay()];
}
function search(name,e){   // search the location
	if (e.keyCode == 13) {	
		document.getElementById("search").value="Please wait...Searching: "+name;
	ajax_get("/search?loc="+name, function(data1) {
	});
		setTimeout(function(){ window.location='index.html'; }, 3000);
	}
}
function search2(e){	  // search the location
	ajax_get("/search?loc="+e.innerHTML, function(data1) {
	});
	
	setTimeout(function(){ window.location='index.html'; }, 3000);
}

function start(){    // start run
   
ajax_get('/getweather', function(data1) {  //get weather details
		var data = $(data1).filter(function (i,n){return n.value.datetime!=null});
	   document.getElementsByClassName("location")[0].innerHTML = data[data.length-9].value.name;
		document.getElementsByClassName("today")[0].innerHTML = timeConverter(data[data.length-9].value.datetime);
		document.getElementsByClassName("weather-desc")[0].innerHTML = data[data.length-9].value.main+", "+data[data.length-9].value.desc;
		//var temp = data[0].value.day.split(".");
		document.getElementsByClassName("temperature")[0].innerHTML = parseFloat(data[data.length-9].value.day).toFixed(0);
		document.getElementsByClassName("c1")[0].innerHTML = parseFloat(data[data.length-9].value.pressure).toFixed(0)+" pressure";
		document.getElementsByClassName("c2")[0].innerHTML = parseFloat(data[data.length-9].value.humidity).toFixed(0)+"% humidity";
		currectloction = data[data.length-9].value.name;
		document.getElementsByClassName("week-day")[0].innerHTML = day(data[data.length-8].value.datetime);
		document.getElementsByClassName("week-day")[1].innerHTML = day(data[data.length-7].value.datetime);
		document.getElementsByClassName("week-day")[2].innerHTML = day(data[data.length-6].value.datetime);
		document.getElementsByClassName("week-day")[3].innerHTML = day(data[data.length-5].value.datetime);
		document.getElementsByClassName("week-day")[4].innerHTML = day(data[data.length-4].value.datetime);
		document.getElementsByClassName("week-day")[5].innerHTML = day(data[data.length-3].value.datetime);
		document.getElementsByClassName("week-day")[6].innerHTML = day(data[data.length-2].value.datetime);
		document.getElementsByClassName("week-day-temperature")[0].innerHTML = parseFloat(data[data.length-8].value.day).toFixed(0);
		document.getElementsByClassName("week-day-temperature")[1].innerHTML = parseFloat(data[data.length-7].value.day).toFixed(0);
		document.getElementsByClassName("week-day-temperature")[2].innerHTML = parseFloat(data[data.length-6].value.day).toFixed(0);
		document.getElementsByClassName("week-day-temperature")[3].innerHTML = parseFloat(data[data.length-5].value.day).toFixed(0);
		document.getElementsByClassName("week-day-temperature")[4].innerHTML = parseFloat(data[data.length-4].value.day).toFixed(0);
		document.getElementsByClassName("week-day-temperature")[5].innerHTML = parseFloat(data[data.length-3].value.day).toFixed(0);
		document.getElementsByClassName("week-day-temperature")[6].innerHTML = parseFloat(data[data.length-2].value.day).toFixed(0);
		document.getElementsByClassName("a")[0].className = "climacon "+data[data.length-8].value.main.toLowerCase().replace("clouds", "cloud").replace("clear", "sun");
		document.getElementsByClassName("b")[0].className = "climacon "+data[data.length-7].value.main.toLowerCase().replace("clouds", "cloud").replace("clear", "sun");
		document.getElementsByClassName("c")[0].className = "climacon "+data[data.length-6].value.main.toLowerCase().replace("clouds", "cloud").replace("clear", "sun");
		document.getElementsByClassName("d")[0].className = "climacon "+data[data.length-5].value.main.toLowerCase().replace("clouds", "cloud").replace("clear", "sun");
		document.getElementsByClassName("e")[0].className = "climacon "+data[data.length-4].value.main.toLowerCase().replace("clouds", "cloud").replace("clear", "sun");
		document.getElementsByClassName("f")[0].className = "climacon "+data[data.length-3].value.main.toLowerCase().replace("clouds", "cloud").replace("clear", "sun");
		document.getElementsByClassName("g")[0].className = "climacon "+data[data.length-2].value.main.toLowerCase().replace("clouds", "cloud").replace("clear", "sun");
		checkCookie();
	
      getfav();
});

}
function getfav(){  // get favourite list
ajax_get('/getfav?user='+getCookie("username"), function(data1) {
		var data = $(data1).filter(function (i,n){return n.value.loc!=null});
		data = $(data).filter(function (i,n){return n.value.uid===getCookie("username")});
		var html = "";
		var array = [];
		for (var i=0;i<data.length;i++){
			html += '<div style="display: inline-block;" onclick="search2(this);">'+data[i].value.loc+'</div>&nbsp;&nbsp;<div style="display: inline-block;" onclick=\'remove("'+data[i].value._id+'","'+data[i].value._rev+'");\'><img width="32px" src="img/remove.png"/></div><p>';
		   array.push(data[i].value.loc);
		}
		document.getElementById("fav").innerHTML = html;
		var app = angular.module("myList", []);
      app.controller("myCtrl", function($scope) {
       $scope.products = array;
       $scope.addItem = function () {
        $scope.products.push($scope.addMe);
    }
});
});
}
function remove(id,rev){   // remove favourite list item
	ajax_get("/remove?id="+id+"&rev="+rev, function(data1) {
	});
	alert("Remove from your favourite list successfully.");
		 window.location='index.html';
}
function checkCookie() {  // get username
    var username=getCookie("username");
    if (username!="") {
        document.getElementById("log").style.display = "none";
		document.getElementById("favourite").style.display = "block";
		document.getElementById("add").style.display = "block";
		document.getElementById("logout").style.display = "block";
    } else {
        document.getElementById("log").style.display = "block";
		document.getElementById("logout").style.display = "none";
		document.getElementById("favourite").style.display = "none";
		document.getElementById("add").style.display = "none";
    }
}
function getCookie(cname) {   //get cookie
    var name = cname + "=";
    var ca = document.cookie.split(';');
    for(var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}
function add(){  // add favourite list item.
	ajax_get("/add?loc="+currectloction+"&name="+getCookie("username"), function(data1) {
	});
	alert("Add to my favourite list successfully!");
	window.location='index.html';
}
</script>
<style>
input[type=text] {
    width: 400px;
    box-sizing: border-box;
    border: 2px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
    background-color: white;
	color: black;
    background-image: url('img/searchicon.png');
    background-position: 10px 10px;
    background-repeat: no-repeat;
    padding: 12px 20px 12px 40px;
    -webkit-transition: width 0.4s ease-in-out;
    transition: width 0.4s ease-in-out;
}
</style>
	  </head>
   <body  onLoad="start()">
   <div style="position:fixed;width:100%;top:0px;left:0px;background-color:#F0F0F0;height:50px;box-shadow: 1px 2px 0px #333;font-family:'Arial';z-index:15;color:#000;"><center><h3>Weather Forecast</h3></center></div>
<div style="position:fixed;width:90%;top:5px;left:0%;height:50px;box-shadow: 0px 0px 0px #333;font-family:'Arial';z-index:16;color:#000;text-align:right;"><div id="log" style="display:none;"><input type="button" id="login" value="Login" onclick="window.location='login.html';" style="text-align: center;font-size: 14px;font-family: 'Arial', sans-serif;font-weight: 700;height: 36px;padding: 0 8px;border: 0px;color: #fff;text-shadow: 0 1px rgba(0,0,0,0.1); background-color: #4d90fe;">&nbsp;&nbsp;<input type="button" id="Register" value="Register" onclick="window.location='register.html';" style="text-align: center;font-size: 14px;font-family: 'Arial', sans-serif;font-weight: 700;height: 36px;padding: 0 8px;border: 0px;color: #fff;text-shadow: 0 1px rgba(0,0,0,0.1); background-color: green;"></div><div id="logout" style="display:none;"><input type="button" id="logout2" value="Logout" onclick="document.cookie = 'username=';window.location='index.html';" style="text-align: center;font-size: 14px;font-family: 'Arial', sans-serif;font-weight: 700;height: 36px;padding: 0 8px;border: 0px;color: #fff;text-shadow: 0 1px rgba(0,0,0,0.1); background-color: #4d90fe;"></div></div></body>
	    <div id="favourite" style="display:none;position:fixed;width:15%;top:50px;left:0px;background-color:white;height:99%;box-shadow: 1px 2px 0px #333;font-family:'Arial';z-index:15;color:#000;"><center><h3>My Favourite</h3></center><div style="padding-left:10px;" id="fav"></div></div>
	 <div class="main-wrapper">
         <div class="main-wrapper-mask"></div>
         <div class="main-wrapper-blur" style="background-image: url(img/paris-lg.jpg)"></div>
         <div class="main-wrapper-front">
            <div class="full-center"> 
				<center><input type="text" id="search" name="search" placeholder="Search Location..." onkeypress="return search(this.value,event);"></center><br>
               <div class="widget-block">
			   	 
               	<!-- MAIN AREA -->
                  <div class="img-area">
                     <div class="img-area-mask"></div>
                     <img src="img/Hong Kong.jpg" alt="">
                     <div class="img-area-front">
                        <h5 class="location">Loading...</h5>
                        <p class="today">Sunday, July 27, 18:00</p>
						<div id = "add" style="padding:5px;display:none;" onclick="add();">Add to my Favourite</div>
                        <div class="weather-desc">
                           <span>Cloudy, rain</span>
                        </div>
                        <ul class="weather-block-info">
                           <li>
                              <p class="temperature">25<span class="temperature-feels"></span></p>
                           </li>
                           <li>
                           	                              <svg
                                 version="1.1"
                                 id="cloudRainSun"
                                 class="climacon climacon_cloudRainSun"
                                 xmlns="http://www.w3.org/2000/svg"
                                 xmlns:xlink="http://www.w3.org/1999/xlink"
                                 x="0px"
                                 y="0px"
                                 viewBox="15 15 70 70"
                                 enable-background="new 15 15 70 70"
                                 xml:space="preserve">
                                 <clipPath id="cloudFillClip">
                                    <path d="M15,15v70h70V15H15z M59.943,61.639c-3.02,0-12.381,0-15.999,0c-6.626,0-11.998-5.371-11.998-11.998c0-6.627,5.372-11.999,11.998-11.999c5.691,0,10.434,3.974,11.665,9.29c1.252-0.81,2.733-1.291,4.334-1.291c4.418,0,8,3.582,8,8C67.943,58.057,64.361,61.639,59.943,61.639z"/>
                                 </clipPath>
                                 <clipPath id="sunCloudFillClip">
                                    <path
                                       d="M15,15v70h70V15H15z M57.945,49.641c-4.417,0-8-3.582-8-7.999c0-4.418,3.582-7.999,8-7.999s7.998,3.581,7.998,7.999C65.943,46.059,62.362,49.641,57.945,49.641z"/>
                                 </clipPath>
                                 <clipPath id="cloudSunFillClip">
                                    <path
                                       d="M15,15v70h20.947V63.481c-4.778-2.767-8-7.922-8-13.84c0-8.836,7.163-15.998,15.998-15.998c6.004,0,11.229,3.312,13.965,8.203c0.664-0.113,1.338-0.205,2.033-0.205c6.627,0,11.998,5.373,11.998,12c0,5.262-3.394,9.723-8.107,11.341V85H85V15H15z"/>
                                 </clipPath>
                                 
                                    <g class="climacon_componentWrap climacon_componentWrap-rain">
                                       <path
                                          class="climacon_component climacon_component-stroke climacon_component-stroke_rain climacon_component-stroke_rain- left"
                                          d="M41.946,53.641c1.104,0,1.999,0.896,1.999,2v15.998c0,1.105-0.895,2-1.999,2s-2-0.895-2-2V55.641C39.946,54.537,40.842,53.641,41.946,53.641z"/>
                                       <path
                                          class="climacon_component climacon_component-stroke climacon_component-stroke_rain climacon_component-stroke_rain- middle"
                                          d="M49.945,57.641c1.104,0,2,0.896,2,2v15.998c0,1.104-0.896,2-2,2s-2-0.896-2-2V59.641C47.945,58.535,48.841,57.641,49.945,57.641z"/>
                                       <path
                                          class="climacon_component climacon_component-stroke climacon_component-stroke_rain climacon_component-stroke_rain- right"
                                          d="M57.943,53.641c1.104,0,2,0.896,2,2v15.998c0,1.105-0.896,2-2,2c-1.104,0-2-0.895-2-2V55.641C55.943,54.537,56.84,53.641,57.943,53.641z"/>
                                       <path
                                          class="climacon_component climacon_component-stroke climacon_component-stroke_rain climacon_component-stroke_rain- left"
                                          d="M41.946,53.641c1.104,0,1.999,0.896,1.999,2v15.998c0,1.105-0.895,2-1.999,2s-2-0.895-2-2V55.641C39.946,54.537,40.842,53.641,41.946,53.641z"/>
                                       <path
                                          class="climacon_component climacon_component-stroke climacon_component-stroke_rain climacon_component-stroke_rain- middle"
                                          d="M49.945,57.641c1.104,0,2,0.896,2,2v15.998c0,1.104-0.896,2-2,2s-2-0.896-2-2V59.641C47.945,58.535,48.841,57.641,49.945,57.641z"/>
                                       <path
                                          class="climacon_component climacon_component-stroke climacon_component-stroke_rain climacon_component-stroke_rain- right"
                                          d="M57.943,53.641c1.104,0,2,0.896,2,2v15.998c0,1.105-0.896,2-2,2c-1.104,0-2-0.895-2-2V55.641C55.943,54.537,56.84,53.641,57.943,53.641z"/>
                                    </g>
                                    <g class="climacon_componentWrap climacon_componentWrap-cloud">
                                       <path
                                          class="climacon_component climacon_component-stroke climacon_component-stroke_cloud"
                                          d="M63.943,64.941v-4.381c2.389-1.384,4-3.961,4-6.92c0-4.417-3.582-8-8-8c-1.601,0-3.082,0.48-4.334,1.291c-1.23-5.317-5.973-9.29-11.665-9.29c-6.626,0-11.998,5.372-11.998,11.998c0,3.549,1.551,6.728,4,8.924v4.916c-4.777-2.768-8-7.922-8-13.84c0-8.835,7.163-15.997,15.998-15.997c6.004,0,11.229,3.311,13.965,8.203c0.664-0.113,1.338-0.205,2.033-0.205c6.627,0,11.998,5.372,11.998,12C71.941,58.863,68.602,63.293,63.943,64.941z"/>
                                    </g>
                                 </g>
                              </svg>
                           </li>
                           <li>
                              <ul class="weather-params">
                                 <li><i class="climacon thermometer medium-high"></i> <span class="c1">743 mm Hg</span></li>
                                 <li><i class="climacon moon full"></i> <span class="c2">46% humidity</span></li>
                              </ul>
                           </li>
                        </ul>
                     </div>
                  </div>
                  <!-- /MAIN AREA -->
                  <!-- WEATHER FORECAST -->
                  <ul class="week-forecast">
                     <li class="sun">
                        <div class="inner">
                           <h5 class="week-day">Monday</h5>
                           <i class="a"></i>

                           <p class="week-day-temperature">30</p>
                        </div>
                     </li>
                     <li class="sun">
                        <div class="inner">
                           <h5 class="week-day">Tuesday</h5>
                          <i class="b"></i>
                           <p class="week-day-temperature">25</p>
                        </div>
                     </li>
                     <li class="sun">
                        <div class="inner">
                           <h5 class="week-day">Wednsday</h5>
							<i class="c"></i>
                           <p class="week-day-temperature">32</p>
                        </div>
                     </li>
                     <li class="sun">
                        <div class="inner">
                           <h5 class="week-day">Thursday</h5>
                          <i class="d"></i>
                           <p class="week-day-temperature">30</p>
                        </div>
                     </li>
                     <li class="sun">
                        <div class="inner">
                           <h5 class="week-day">Friday</h5>
                          <i class="e"></i>
                           <p class="week-day-temperature">29</p>
                        </div>
                     </li>
                     <li class="sun">
                        <div class="inner">
                           <h5 class="week-day">Saturday</h5>
                         <i class="f"></i>
                           <p class="week-day-temperature">25</p>
                        </div>
                     </li>
                     <li class="sun">
                        <div class="inner">
                           <h5 class="week-day">Sunday</h5>
                          <i class="g"></i>
                           <p class="week-day-temperature">22</p>
                        </div>
                     </li>
                  </ul>
                  <!-- /WEATHER FORECAST -->
               </div>
            </div>
         </div>	  
      </div>

   </body>
</html>